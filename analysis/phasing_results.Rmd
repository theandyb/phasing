---
title: "10aug22_diploid_results"
author: "Andy Beck"
date: "2022-08-10"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Libraries and global variables

```{r}
library(tidyverse)
library(janitor)
source("code/common_functions.R")

library(ggsci)
library(reactable)
theme_set(theme_bw(base_size = 18))

pal1 <- pal_ucscgb()

svg_out_dir <- "/net/snowwhite/home/beckandy/research/phasing/output/figures/paper_svg/"

eagle_switch_dir <-   "/net/snowwhite/home/beckandy/research/phasing/output/final_switch_errors/switch_errors/eagle/annotated/"
shapeit_switch_dir <- "/net/snowwhite/home/beckandy/research/phasing/output/final_switch_errors/switch_errors/shapeit/annotated/"
beagle_switch_dir <-  "/net/snowwhite/home/beckandy/research/phasing/output/final_switch_errors/switch_errors/beagle/annotated/"
num_sites_dir <-      "/net/snowwhite/home/beckandy/research/phasing/output/final_switch_errors/vcf_n_sites/"
whatshap_dir <-       "/net/snowwhite/home/beckandy/research/phasing/output/final_switch_errors/whatshap/"
whatshap_dir2 <-      "/net/snowwhite/home/beckandy/research/phasing/output/final_switch_errors/whatshap/"
het_loc_dir <-        "/net/snowwhite/home/beckandy/research/phasing/output/final_switch_errors/het_loc/"

pair_info_df <- read_delim("data/sample_pairs_9aug2023.csv", col_names = c("POP", "ID1", "ID2"))
pair_info_df$SP <- c(rep("EUR", 200), rep("AFR", 200), rep("AMR", 100), rep("EAS", 100), rep("SAS", 100))

gc_content_1kb <- read_tsv("data/ref/gc1kb_X_only.bed")
colnames(gc_content_1kb) <- c("CHR", "START", "END", "AT", "GC", "A", "C", "G", "T", "TOTAL", "OTHER", "LENGTH")
gc_content_1kb  <- gc_content_1kb %>%
  mutate(bin_id = (START / 1000) + 1)

background_dimer <- read_csv("/net/snowwhite/home/beckandy/research/phasing/output/background_rates/dimer.csv")
background_3mer <- read_csv("/net/snowwhite/home/beckandy/research/phasing/output/background_rates/3mer.csv")

cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

background_cpg_het <- 229868 / 1567042
```

## Single Pseudo-diploid Example

```{r}
pair_id <- 1
bin_size = 1000

het_df <- read_tsv(paste0(paste0(het_loc_dir, "pair_", pair_id, "_het_loc.txt")),
                   col_names = c("chr", "pos_start", "gt"), show_col_types = FALSE) %>%
  select(chr, pos_start) %>%
  mutate(pos_end = lead(pos_start)) %>%
  drop_na()

switch_err_eagle <- read_csv(paste0(eagle_switch_dir, "switch_", pair_id, ".csv")) %>% 
  mutate(bin_id = ceiling(pos_start / bin_size))
switch_err_shapeit <- read_csv(paste0(shapeit_switch_dir, "switch_", pair_id, ".csv")) %>%
  mutate(bin_id = ceiling(pos_start / bin_size))
switch_err_beagle <- read_csv(paste0(beagle_switch_dir, "switch_", pair_id, ".csv")) %>%
  mutate(bin_id = ceiling(pos_start / bin_size))

whatshap_eagle <- read_tsv(paste0(whatshap_dir, "/eagle/eval_", pair_id, ".tsv")) %>% 
  clean_names() %>%
  select(all_assessed_pairs, all_switches, all_switch_rate, all_switchflips, all_switchflip_rate) %>%
  mutate(switches = as.numeric(str_split(all_switchflips, "/")[[1]][1]),
         flips = as.numeric(str_split(all_switchflips, "/")[[1]][2])) %>%
  rename(n_het = all_assessed_pairs, total_errors = all_switches, error_rate = all_switch_rate) %>%
  select(-all_switchflips)

whatshap_shapeit <- read_tsv(paste0(whatshap_dir2, "/shapeit/eval_", pair_id, ".tsv")) %>% 
  clean_names() %>%
  select(all_assessed_pairs, all_switches, all_switch_rate, all_switchflips, all_switchflip_rate) %>%
  mutate(switches = as.numeric(str_split(all_switchflips, "/")[[1]][1]),
         flips = as.numeric(str_split(all_switchflips, "/")[[1]][2])) %>%
  rename(n_het = all_assessed_pairs, total_errors = all_switches, error_rate = all_switch_rate) %>%
  select(-all_switchflips)

whatshap_beagle <- read_tsv(paste0(whatshap_dir, "/beagle/eval_", pair_id, ".tsv")) %>% 
  clean_names() %>%
  select(all_assessed_pairs, all_switches, all_switch_rate, all_switchflips, all_switchflip_rate) %>%
  mutate(switches = as.numeric(str_split(all_switchflips, "/")[[1]][1]),
         flips = as.numeric(str_split(all_switchflips, "/")[[1]][2])) %>%
  rename(n_het = all_assessed_pairs, total_errors = all_switches, error_rate = all_switch_rate) %>%
  select(-all_switchflips)

flip_pos_beagle <- get_flip_pos(switch_err_beagle)
flip_pos_eagle <- get_flip_pos(switch_err_eagle)
flip_pos_shapeit <- get_flip_pos(switch_err_shapeit)

switch_err_beagle$is_flip <- (switch_err_beagle$pos_start %in% flip_pos_beagle) | (switch_err_beagle$pos_end %in% flip_pos_beagle)

switch_err_eagle$is_flip <- (switch_err_eagle$pos_start %in% flip_pos_eagle) | (switch_err_eagle$pos_end %in% flip_pos_eagle)

switch_err_shapeit$is_flip <- (switch_err_shapeit$pos_start %in% flip_pos_shapeit) | (switch_err_shapeit$pos_end %in% flip_pos_shapeit)

switch_err_beagle$start_flip <- switch_err_beagle$pos_end %in% flip_pos_beagle
switch_err_eagle$start_flip <- switch_err_eagle$pos_end %in% flip_pos_eagle
switch_err_shapeit$start_flip <- switch_err_shapeit$pos_end %in% flip_pos_shapeit

switch_err_eagle <- switch_err_eagle %>%
  left_join({gc_content_1kb %>% select(bin_id, GC)}, by = "bin_id")

switch_err_beagle <- switch_err_beagle %>%
  left_join({gc_content_1kb %>% select(bin_id, GC)}, by = "bin_id")

switch_err_shapeit <- switch_err_shapeit %>%
  left_join({gc_content_1kb %>% select(bin_id, GC)}, by = "bin_id")

# Append switch/flip status to het_df

## BEAGLE

het_df <- het_df %>%
  mutate(beagle_switch = pos_start %in% {
    switch_err_beagle %>%
      filter(!is_flip) %>%
      pull(pos_start)},
    beagle_flip = pos_start %in% {
      switch_err_beagle %>%
        filter(start_flip) %>%
        pull(pos_start)
    })

## EAGLE
het_df <- het_df %>%
  mutate(eagle_switch = pos_start %in% {
    switch_err_eagle %>%
      filter(!is_flip) %>%
      pull(pos_start)},
    eagle_flip = pos_start %in% {
      switch_err_eagle %>%
        filter(start_flip) %>%
        pull(pos_start)
    })

## SHAPEIT
het_df <- het_df %>%
  mutate(shapeit_switch = pos_start %in% {
    switch_err_shapeit %>%
      filter(!is_flip) %>%
      pull(pos_start)},
    shapeit_flip = pos_start %in% {
      switch_err_shapeit %>%
        filter(start_flip) %>%
        pull(pos_start)
    })

# Add index to het_df
het_df$id <- 1:length(het_df$chr)

# Compute distance between distinct errors

switch_err_beagle %>%
  filter(is_flip == F | start_flip == T) %>% # filter out latter halves of flips
  pull(pos_start) %>%
  diff(lag = 1)

# Overlap of errors

intersect({switch_err_beagle %>% filter(start_flip) %>% pull(pos_start)},
          {switch_err_eagle %>% filter(start_flip) %>% pull(pos_start)}) %>%
  length()

intersect({switch_err_shapeit %>% filter(start_flip) %>% pull(pos_start)},
          {switch_err_eagle %>% filter(start_flip) %>% pull(pos_start)}) %>%
  length()

intersect({switch_err_shapeit %>% filter(start_flip) %>% pull(pos_start)},
          {switch_err_beagle %>% filter(start_flip) %>% pull(pos_start)}) %>%
  length()

intersect(intersect({switch_err_beagle %>% filter(start_flip) %>% pull(pos_start)},
          {switch_err_eagle %>% filter(start_flip) %>% pull(pos_start)}), 
          {switch_err_shapeit %>% filter(start_flip) %>% pull(pos_start)}) %>%
  length()

# Number of flips starting at CpG
switch_err_beagle %>%
  filter(start_flip == TRUE) %>%
  pull(cpg_start) %>%
  sum()

switch_err_eagle %>%
  filter(start_flip == TRUE) %>%
  pull(cpg_start) %>%
  sum()

switch_err_shapeit %>%
  filter(start_flip == TRUE) %>%
  pull(cpg_start) %>%
  sum()

# Number of non-flips starting at CpG
switch_err_beagle %>%
  filter(is_flip == FALSE) %>%
  pull(cpg_start) %>%
  sum()

switch_err_eagle %>%
  filter(is_flip == FALSE) %>%
  pull(cpg_start) %>%
  sum()

switch_err_shapeit %>%
  filter(is_flip == FALSE) %>%
  pull(cpg_start) %>%
  sum()

# Number of heterozyogus locations between errors
het_df %>%
  filter(shapeit_switch) %>%
  mutate(next_id = lead(id)) %>%
  mutate(hets_btw = next_id - id - 1) %>%
  drop_na() %>%
  pull(hets_btw) %>%
  summary()

het_df %>%
  filter(shapeit_switch) %>%
  mutate(next_id = lead(id)) %>%
  mutate(hets_btw = next_id - id - 1) %>%
  drop_na() %>%
  ggplot(aes(x = hets_btw)) +
  geom_density()

het_df %>%
  filter(shapeit_switch) %>%
  mutate(next_id = lead(id)) %>%
  mutate(hets_btw = next_id - id - 1) %>%
  drop_na() %>%
  ggplot(aes(x = pos_start, y = hets_btw)) +
  geom_point()

```


## Summary statistics on all pseudo-diploids

From vcftools:

```{r}
df_vcftools <- lapply(c(1:700), 
                    function(x){
                      switch_summary(x, eagle_switch_dir, beagle_switch_dir, shapeit_switch_dir, gc_content_1kb, het_loc_dir)
                      }) %>%
  bind_rows()

df_vcftools$pop <- c(rep("EUR", 200), rep("AFR", 200), rep("AMR", 100), rep("EAS", 100), rep("SAS", 100))
```

From whatshap:

```{r}
df_wh_eagle <- get_all_whatshap("eagle", n = 700, pop = c(rep("EUR", 200), rep("AFR", 200), rep("AMR", 100), rep("EAS", 100), rep("SAS", 100)))
df_wh_beagle <- get_all_whatshap("beagle", n = 700, pop = c(rep("EUR", 200), rep("AFR", 200), rep("AMR", 100), rep("EAS", 100), rep("SAS", 100)))
df_wh_si <- get_all_whatshap("shapeit", n = 700, pop = c(rep("EUR", 200), rep("AFR", 200), rep("AMR", 100), rep("EAS", 100), rep("SAS", 100)))
```

### Tables

#### Mean number of switches and flips

```{r}
df_vcftools %>%
  group_by(pop) %>%
  summarize(mean_switch_eagle = mean(n_other_eagle),
            mean_switch_beagle = mean(n_other_beagle),
            mean_switch_shapeit = mean(n_other_shapeit),
            mean_flip_eagle = mean(n_flip_eagle),
            mean_flip_beagle = mean(n_flip_beagle),
            mean_flip_shapeit = mean(n_flip_shapeit)) %>%
  reactable()
```

#### Mean median numnber of heterozygous sites between errors

```{r}
df_vcftools %>%
  group_by(pop) %>%
  summarize(mean_het_switch_beagle = mean(med_hets_switch_beagle),
            mean_het_switch_eagle = mean(med_hets_switch_eagle),
            mean_het_switch_shapeit = mean(med_hets_switch_shapeit)) %>%
  reactable()
```

```{r}
df_vcftools %>%
  group_by(pop) %>%
  summarize(mean_het_flip_beagle = mean(med_hets_flip_beagle),
            mean_het_flip_eagle = mean(med_hets_flip_eagle),
            mean_het_flip_shapeit = mean(med_hets_flip_shapeit)) %>%
  reactable()
```

Note here that the populations will also differ in regards to the mean number of heterozygous sites in each pseudo-diploid:

```{r}
df_vcftools %>%
  group_by(pop) %>%
  summarize(mean_n_het = mean(n_hets),
            sd_n_het = sd(n_hets)) %>%
  reactable()
```


### Total Errors

```{r}
df_wh_si %>%
  select(id, pop, total_errors) %>%
  rename(shapeit = total_errors) %>%
  inner_join({df_wh_eagle %>% select(id, pop, total_errors) %>% rename(eagle = total_errors)}, by = c("id", "pop")) %>%
  ggplot(aes(x = shapeit, y = eagle, colour = pop)) + 
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  ggtitle("Total Errors") +
  xlab("SHAPEIT5 Errors") +
  ylab("EAGLE2 Errors") +
  guides(colour=guide_legend(title="Population")) +
  scale_color_jco() +
  theme_bw(base_size = 14) +
  theme(legend.position = c(0.2, .85))
```

```{r}
df_wh_si %>%
  select(id, pop, total_errors) %>%
  rename(shapeit = total_errors) %>%
  inner_join({df_wh_beagle %>% select(id, pop, total_errors) %>% rename(beagle = total_errors)}, by = c("id", "pop")) %>%
  ggplot(aes(x = shapeit, y = beagle, colour = pop)) + 
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  ggtitle("Total Errors") +
  xlab("SHAPEIT5 Errors") +
  ylab("BEAGLE5 Errors") +
  guides(colour=guide_legend(title="Population")) +
  scale_color_jco() +
  theme_bw(base_size = 14) +
  theme(legend.position = c(0.8, .2))
```

```{r}
df_wh_eagle %>%
  select(id, pop, total_errors) %>%
  rename(eagle = total_errors) %>%
  inner_join({df_wh_beagle %>% select(id, pop, total_errors) %>% rename(beagle = total_errors)}, by = c("id", "pop")) %>%
  ggplot(aes(x = eagle, y = beagle, colour = pop)) + 
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  ggtitle("Total Errors") +
  xlab("EAGLE2 Errors") +
  ylab("BEAGLE5 Errors") +
  guides(colour=guide_legend(title="Population")) +
  scale_color_jco() +
  theme_bw(base_size = 16) +
  theme(legend.position = c(0.8, .2))
```

### Switches

```{r}
df_wh_si %>%
  select(id, pop, switches) %>%
  rename(shapeit = switches) %>%
  inner_join({df_wh_eagle %>% select(id, pop, switches) %>% rename(eagle = switches)}, by = c("id", "pop")) %>%
  ggplot(aes(x = shapeit, y = eagle, colour = pop)) + 
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  ggtitle("Switches") +
  xlab("SHAPEIT5 Switches") +
  ylab("EAGLE2 Switches") +
  guides(colour=guide_legend(title="Population")) +
  scale_color_jco() +
  theme_bw(base_size = 16) +
  theme(legend.position = c(0.2, .85))
```

```{r}
df_wh_si %>%
  select(id, pop, switches) %>%
  rename(shapeit = switches) %>%
  inner_join({df_wh_beagle %>% select(id, pop, switches) %>% rename(beagle = switches)}, by = c("id", "pop")) %>%
  ggplot(aes(x = shapeit, y = beagle, colour = pop)) + 
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  ggtitle("Switches") +
  xlab("SHAPEIT5 Switches") +
  ylab("BEAGLE5 Switches") +
  guides(colour=guide_legend(title="Population")) +
  scale_color_jco() +
  theme_bw(base_size = 16) +
  theme(legend.position = c(0.8, .2))
```

```{r}
df_wh_eagle %>%
  select(id, pop, switches) %>%
  rename(eagle = switches) %>%
  inner_join({df_wh_beagle %>% select(id, pop, switches) %>% rename(beagle = switches)}, by = c("id", "pop")) %>%
  ggplot(aes(x = eagle, y = beagle, colour = pop)) + 
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  ggtitle("Switches") +
  xlab("EAGLE2 Switches") +
  ylab("BEAGLE5 Switches") +
  guides(colour=guide_legend(title="Population")) +
  scale_color_jco() +
  theme_bw(base_size = 16) +
  theme(legend.position = c(0.8, .2))
```

### Error Rates

Plot error rates against pairs of methods:

```{r}
out_file <- paste0(svg_out_dir, "error_rate_si_e.svg")
df_wh_si %>%
  select(id, pop, all_switchflip_rate) %>%
  rename(shapeit = all_switchflip_rate) %>%
  inner_join({df_wh_eagle %>% select(id, pop, all_switchflip_rate) %>% rename(eagle = all_switchflip_rate)}, by = c("id", "pop")) %>%
  ggplot(aes(x = shapeit, y = eagle, colour = pop)) + 
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  ggtitle("Switch/Flip Rate", "#(Switches + Flips) / #(Heterozygous Sites)") +
  xlab("SHAPEIT5 Error Rate") +
  ylab("EAGLE2 Error Rate") +
  guides(colour=guide_legend(title="Population")) +
  scale_color_jco() +
  theme_bw(base_size = 16) +
  xlim(c(0,0.006)) + ylim(c(0,0.006)) +
  theme(legend.position = c(0.8, .2))
ggsave(filename = out_file, width = 5.33, height = 4.26, dpi = 300, units = "in")

```

```{r}
df_wh_si %>%
  select(id, pop, all_switchflip_rate) %>%
  rename(shapeit = all_switchflip_rate) %>%
  inner_join({df_wh_beagle %>% select(id, pop, all_switchflip_rate) %>% rename(beagle = all_switchflip_rate)}, by = c("id", "pop")) %>%
  ggplot(aes(x = shapeit, y = beagle, colour = pop)) + 
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  ggtitle("Switch/Flip Rate", "#(Switches + Flips) / #(Heterozygous Sites)")  +
  xlab("SHAPEIT5 Error Rate") +
  ylab("BEAGLE5 Error Rate") +
  guides(colour=guide_legend(title="Population")) + 
  scale_color_jco() +
  theme_bw(base_size = 16) +
  xlim(c(0,0.008)) + ylim(c(0,0.008)) +
  theme(legend.position = c(0.8, .2))
out_file <- paste0(svg_out_dir, "error_rate_si_b.svg")
ggsave(filename = out_file, width = 5.33, height = 4.26, dpi = 300, units = "in")
```

```{r}
df_wh_eagle %>%
  select(id, pop, all_switchflip_rate) %>%
  rename(eagle = all_switchflip_rate) %>%
  inner_join({df_wh_beagle %>% select(id, pop, all_switchflip_rate) %>% rename(beagle = all_switchflip_rate)}, by = c("id", "pop")) %>%
  ggplot(aes(x = eagle, y = beagle, colour = pop)) + 
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  ggtitle("Switch/Flip Rate", "#(Switches + Flips) / #(Heterozygous Sites)")  +
  xlab("EAGLE2 Error Rate") +
  ylab("BEAGLE5 Error Rate") +
  guides(colour=guide_legend(title="Population")) + 
  scale_color_jco() +
  theme_bw(base_size = 16) +
  xlim(c(0,0.008)) + ylim(c(0,0.008)) +
  theme(legend.position = c(0.8, .2))
out_file <- paste0(svg_out_dir, "error_rate_e_b.svg")
ggsave(filename = out_file, width = 5.33, height = 4.26, dpi = 300, units = "in")
```

### Flips by method

```{r}
df_wh_si %>%
  select(id, pop, flips, n_het) %>%
  rename(shapeit = flips) %>%
  inner_join({df_wh_eagle %>% select(id, pop, flips) %>% rename(eagle = flips)}, by = c("id", "pop")) %>%
  ggplot(aes(x = shapeit, y = eagle, colour = pop)) + 
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  ggtitle("Flips per pseudo-diplod") +
  xlab("SHAPEIT5 flips") +
  ylab("EAGLE2 flips") +
  guides(colour=guide_legend(title="Population")) +
  scale_color_jco() +
  theme_bw(base_size = 16) +
  theme(legend.position = c(0.8, .2))
```

```{r}
df_wh_si %>%
  select(id, pop, flips, n_het) %>%
  rename(shapeit = flips) %>%
  inner_join({df_wh_beagle %>% select(id, pop, flips) %>% rename(beagle = flips)}, by = c("id", "pop")) %>%
  ggplot(aes(x = shapeit, y = beagle, colour = pop)) + 
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  ggtitle("Flips per pseudo-diplod") +
  xlab("SHAPEIT5 flips") +
  ylab("BEAGLE5 flips") +
  guides(colour=guide_legend(title="Population")) +
  scale_color_jco() +
  theme_bw(base_size = 16) +
  theme(legend.position = c(0.8, .2))
```

```{r}
df_wh_eagle %>%
  select(id, pop, flips, n_het) %>%
  rename(eagle = flips) %>%
  inner_join({df_wh_beagle %>% select(id, pop, flips) %>% rename(beagle = flips)}, by = c("id", "pop")) %>%
  ggplot(aes(x = eagle, y = beagle, colour = pop)) + 
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  ggtitle("Flips per pseudo-diplod") +
  xlab("EAGLE2 flips") +
  ylab("BEAGLE5 flips") +
  guides(colour=guide_legend(title="Population")) +
  scale_color_jco() +
  theme_bw(base_size = 16) +
  theme(legend.position = c(0.8, .2))
```

### Flip Rate

```{r}
df_wh_si %>%
  select(id, pop, flips, n_het) %>%
  mutate(flips = flips / (n_het)) %>%
  rename(shapeit = flips) %>%
  inner_join({df_wh_eagle %>% 
      select(id, pop, flips, n_het) %>% 
      mutate(flips = flips / (n_het)) %>%
      rename(eagle = flips)}, by = c("id", "pop")) %>%
  ggplot(aes(x = shapeit, y = eagle, colour = pop)) + 
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  ggtitle("Flip Rate", "#(Flips) / #(Heterozygous Sites)") +
  xlab("SHAPEIT5 Flip Rate") +
  ylab("EAGLE2 flips") +
  guides(colour=guide_legend(title="Population")) + 
  scale_color_jco() +
  theme_bw(base_size = 16) +
  xlim(c(0,0.003)) + ylim(c(0,0.003)) +
  theme(legend.position = c(0.8, .2))
out_file <- paste0(svg_out_dir, "flip_rate_s_e.svg")
ggsave(filename = out_file, width = 5.33, height = 4.26, dpi = 300, units = "in")

df_wh_si %>%
  select(id, pop, flips, n_het) %>%
  mutate(flips = flips / (n_het)) %>%
  rename(shapeit = flips) %>%
  inner_join({df_wh_beagle %>% 
      select(id, pop, flips, n_het) %>% 
      mutate(flips = flips / (n_het)) %>%
      rename(beagle = flips)}, by = c("id", "pop")) %>%
  ggplot(aes(x = shapeit, y = beagle, colour = pop)) + 
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  ggtitle("Flip Rate", "# Flips / #(Heterozygous Sites)") +
  xlab("SHAPEIT5 Flip Rate") +
  ylab("BEAGLE5 Flip Rate") +
  guides(colour=guide_legend(title="Population")) +
  scale_color_jco() +
  theme_bw(base_size = 16) +
  xlim(c(0,0.003)) + ylim(c(0,0.003)) +
  theme(legend.position = c(0.8, .2))
out_file <- paste0(svg_out_dir, "flip_rate_s_b.svg")
ggsave(filename = out_file, width = 5.33, height = 4.26, dpi = 300, units = "in")

df_wh_eagle %>%
  select(id, pop, flips, n_het) %>%
  mutate(flips = flips / (n_het)) %>%
  rename(eagle = flips) %>%
  inner_join({df_wh_beagle %>% 
      select(id, pop, flips, n_het) %>% 
      mutate(flips = flips / (n_het)) %>%
      rename(beagle = flips)}, by = c("id", "pop")) %>%
  ggplot(aes(x = eagle, y = beagle, colour = pop)) + 
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  ggtitle("Flip Rate", "# Flips / #(Heterozygous Sites)") +
  xlab("EAGLE2 flips") +
  ylab("BEAGLE5 flips") +
  guides(colour=guide_legend(title="Population")) +
  scale_color_jco() +
  theme_bw(base_size = 16) +
  xlim(c(0,0.003)) + ylim(c(0,0.003)) +
  theme(legend.position = c(0.8, .2))
out_file <- paste0(svg_out_dir, "flip_rate_b_e.svg")
ggsave(filename = out_file, width = 5.33, height = 4.26, dpi = 300, units = "in")
```

### Switch Rate

```{r}
df_wh_si %>%
  select(id, pop, switches, n_het) %>%
  mutate(switches = switches / (n_het)) %>%
  rename(shapeit = switches) %>%
  inner_join({df_wh_eagle %>% 
      select(id, pop, switches, n_het) %>% 
      mutate(switches = switches / (n_het)) %>%
      rename(eagle = switches)}, by = c("id", "pop")) %>%
  ggplot(aes(x = shapeit, y = eagle, colour = pop)) + 
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  ggtitle("Switch Rate", "#(Switches) / #(Heterozygous Sites)") +
  xlab("SHAPEIT5 Switch Rate") +
  ylab("EAGLE2 Switch Rate") +
  guides(colour=guide_legend(title="Population")) + 
  scale_color_jco() +
  theme_bw(base_size = 16) +
  xlim(c(0,0.0052)) + ylim(c(0,0.0052)) +
  theme(legend.position = c(0.8, .2))
out_file <- paste0(svg_out_dir, "switch_rate_s_e.svg")
ggsave(filename = out_file, width = 5.33, height = 4.26, dpi = 300, units = "in")

df_wh_si %>%
  select(id, pop, switches, n_het) %>%
  mutate(switches = switches / (n_het)) %>%
  rename(shapeit = switches) %>%
  inner_join({df_wh_beagle %>% 
      select(id, pop, switches, n_het) %>% 
      mutate(switches = switches / (n_het)) %>%
      rename(beagle = switches)}, by = c("id", "pop")) %>%
  ggplot(aes(x = shapeit, y = beagle, colour = pop)) + 
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  ggtitle("Switch Rate", "# Switches / #(Heterozygous Sites)") +
  xlab("SHAPEIT5 Switch Rate") +
  ylab("BEAGLE5 Switch Rate") +
  guides(colour=guide_legend(title="Population")) +
  scale_color_jco() +
  theme_bw(base_size = 16) +
  xlim(c(0,0.005)) + ylim(c(0,0.005)) +
  theme(legend.position = c(0.8, .2))
out_file <- paste0(svg_out_dir, "switch_rate_s_b.svg")
ggsave(filename = out_file, width = 5.33, height = 4.26, dpi = 300, units = "in")

df_wh_eagle %>%
  select(id, pop, switches, n_het) %>%
  mutate(switches = switches / (n_het)) %>%
  rename(eagle = switches) %>%
  inner_join({df_wh_beagle %>% 
      select(id, pop, switches, n_het) %>% 
      mutate(switches = switches / (n_het)) %>%
      rename(beagle = switches)}, by = c("id", "pop")) %>%
  ggplot(aes(x = eagle, y = beagle, colour = pop)) + 
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  ggtitle("Switch Rate", "# Switches / #(Heterozygous Sites)") +
  xlab("EAGLE2 Switch Rate") +
  ylab("BEAGLE5 Switch Rate") +
  guides(colour=guide_legend(title="Population")) +
  scale_color_jco() +
  theme_bw(base_size = 16) +
  xlim(c(0,0.0052)) + ylim(c(0,0.0052)) +
  theme(legend.position = c(0.8, .2))
out_file <- paste0(svg_out_dir, "switch_rate_b_e.svg")
ggsave(filename = out_file, width = 5.33, height = 4.26, dpi = 300, units = "in")
```

### Hets between switches

#### Shapeit vs BEAGLE
```{r}
df_vcftools %>% 
  ggplot(aes(x = med_hets_switch_shapeit, y = med_hets_switch_beagle, color = pop)) +
  geom_point() +
  scale_color_jco() +
  xlab("SHAPEIT") +
  ylab("BEAGLE") +
  ggtitle("Median Heterozygous Sites \nBetween Switches") +
  geom_abline(slope = 1, intercept = 0) +
  theme_bw(base_size = 12) +
  theme(legend.position = c(0.85, .25)) +
  guides(colour=guide_legend(title="Population"))
```

```{r}
df_vcftools %>% 
  mutate(sr_shapeit = med_hets_switch_shapeit / n_hets,
         sr_beagle = med_hets_switch_beagle / n_hets) %>%
  filter(pop %in% c("AFR", "EUR")) %>%
  ggplot(aes(x = sr_shapeit, y = sr_beagle, color = pop)) +
  geom_point() +
  scale_color_jco() +
  xlab("SHAPEIT") +
  ylab("BEAGLE") +
  ggtitle("Median Heterozygous Sites \nBetween Switches") +
  geom_abline(slope = 1, intercept = 0) +
  theme_bw(base_size = 12) +
  theme(legend.position = c(0.85, .25)) +
  guides(colour=guide_legend(title="Population"))
```

#### Shapeit vs EAGLE

```{r}
df_vcftools %>% 
  ggplot(aes(x = med_hets_switch_shapeit, y = med_hets_switch_eagle, color = pop)) +
  geom_point() +
  scale_color_jco() +
  xlab("SHAPEIT") +
  ylab("EAGLE") +
  ggtitle("Median Heterozygous Sites \nBetween Switches") +
  geom_abline(slope = 1, intercept = 0) +
  theme_bw(base_size = 12) +
  theme(legend.position = c(0.85, .25)) +
  guides(colour=guide_legend(title="Population"))
```

```{r}
df_vcftools %>% 
  mutate(sr_shapeit = med_hets_switch_shapeit / n_hets,
         sr_eagle = med_hets_switch_eagle / n_hets) %>%
  filter(pop %in% c("AFR", "EUR")) %>%
  ggplot(aes(x = sr_shapeit, y = sr_eagle, color = pop)) +
  geom_point() +
  scale_color_jco() +
  xlab("SHAPEIT") +
  ylab("EAGLE") +
  ggtitle("Median Heterozygous Sites \nBetween Switches") +
  geom_abline(slope = 1, intercept = 0) +
  theme_bw(base_size = 12) +
  theme(legend.position = c(0.85, .25)) +
  guides(colour=guide_legend(title="Population"))
```

#### BEAGLE vs EAGLE

```{r}
df_vcftools %>% 
  ggplot(aes(x = med_hets_switch_beagle, y = med_hets_switch_eagle, color = pop)) +
  geom_point() +
  scale_color_jco() +
  xlab("BEAGLE") +
  ylab("EAGLE") +
  ggtitle("Median Heterozygous Sites \nBetween Switches") +
  geom_abline(slope = 1, intercept = 0) +
  theme_bw(base_size = 12) +
  theme(legend.position = c(0.88, .75)) +
  guides(colour=guide_legend(title="Population"))
```

```{r}
df_vcftools %>% 
  mutate(sr_beagle = med_hets_switch_beagle / n_hets,
         sr_eagle = med_hets_switch_eagle / n_hets) %>%
  filter(pop %in% c("AFR", "EUR")) %>%
  ggplot(aes(x = sr_beagle, y = sr_eagle, color = pop)) +
  geom_point() +
  scale_color_jco() +
  xlab("BEAGLE") +
  ylab("EAGLE") +
  ggtitle("Median Heterozygous Sites \nBetween Switches") +
  geom_abline(slope = 1, intercept = 0) +
  theme_bw(base_size = 12) +
  guides(colour=guide_legend(title="Population"))
```


### Tables for ASHG 2022

```{r}
library(corrr)
df_wh_beagle %>% 
  select(pop, id, n_het) %>% 
  rename(beagle = n_het) %>%
  full_join({
    df_wh_eagle %>%
      select(pop, id, n_het) %>%
      rename(eagle = n_het)
  }) %>%
  select(eagle, beagle) %>%
  correlate()
```


```{r}
old <- options(pillar.sigfig = 7)
df_wh_beagle %>% 
  select(pop, n_het, total_errors, switches, flips)  %>%
  mutate(error_rate = total_errors / n_het,
         flip_rate = flips / n_het, 
         non_flip_rate = switches / n_het) %>%
  group_by(pop) %>%
  summarize(across(n_het:non_flip_rate, ~ mean(.x, na.rm=T))) 
df_wh_eagle %>% 
  select(pop, n_het, total_errors, switches, flips) %>%
  mutate(error_rate = total_errors / n_het,
         flip_rate = flips / n_het, 
         non_flip_rate = switches / n_het) %>%
  group_by(pop) %>%
  summarize(across(n_het:non_flip_rate, ~ mean(.x, na.rm=T))) 
df_wh_si %>% 
  select(pop, n_het, total_errors, switches, flips) %>%
  mutate(error_rate = total_errors / n_het,
         flip_rate = flips / n_het, 
         non_flip_rate = switches / n_het) %>%
  group_by(pop) %>%
  summarize(across(n_het:non_flip_rate, ~ mean(.x, na.rm=T))) 
```

### Errors at CpGs

Proportion of errors at CpG

```{r}
df_vcftools %>%
  mutate(prop_error_eagle = n_switch_cpg_eagle / n_switch_eagle,
         prop_error_shapeit = n_switch_cpg_shapeit / n_switch_shapeit,
         prop_error_beagle = n_switch_cpg_beagle / n_switch_beagle) %>%
  select(pop, starts_with("prop_error")) %>%
  rename(EAGLE2 = prop_error_eagle,
         BEAGLE5 = prop_error_beagle,
         SHAPEIT5 = prop_error_shapeit) %>%
  pivot_longer(-pop, names_to = "method",  values_to = "prop") %>%
  ggplot(aes(x = method, y = prop)) + 
  geom_boxplot() +
  xlab("Phasing Method") +
  ylab("Proportion of errors at CpG") +
  geom_abline(aes(slope = 0, intercept = background_cpg_het, colour = 'red'), show.legend = TRUE) +
  scale_color_manual(values = "red") +
  ggtitle("Proportion of Phasing Errors at CpG Sites") +
  theme_bw(base_size = 14) + labs(color = "") +
  scale_color_discrete(labels = "Background CpG Rate") +
  theme(legend.position = c(0.75, 0.9),
        legend.box.background = element_rect(color="black", linewidth=1),
        legend.title=element_blank())
out_file <- paste0(svg_out_dir, "prop_errors_cpg.svg")
ggsave(filename = out_file, width = 8.05, height = 6.44, dpi = 300, units = "in")

df_vcftools %>%
  mutate(prop_error_eagle = n_flip_cpg_eagle / n_flip_eagle,
         prop_error_shapeit = n_flip_cpg_shapeit / n_flip_shapeit,
         prop_error_beagle = n_flip_cpg_beagle / n_flip_beagle) %>%
  select(pop, starts_with("prop_error")) %>%
  rename(EAGLE2 = prop_error_eagle,
         BEAGLE5 = prop_error_beagle,
         SHAPEIT5 = prop_error_shapeit) %>%
  pivot_longer(-pop, names_to = "method",  values_to = "prop") %>%
  ggplot(aes(x = method, y = prop)) + 
  geom_boxplot() +
  xlab("Phasing Method") +
  ylab("Proportion of flips at CpG") +
  geom_abline(aes(slope = 0, intercept = background_cpg_het, colour = 'red'), show.legend = TRUE) +
  ggtitle("Proportion of Flips Starting at CpG Sites") +
  theme_bw(base_size = 14)  +
  scale_color_discrete(labels = "Background CpG Rate") +
  theme(legend.position = c(0.75, 0.9),
        legend.box.background = element_rect(color="black", linewidth=1),
        legend.title=element_blank())
out_file <- paste0(svg_out_dir, "prop_flips_cpg.svg")
ggsave(filename = out_file, width = 8.05, height = 6.44, dpi = 300, units = "in")
```

```{r}
df_vcftools %>%
  mutate(prop_error_eagle = n_other_cpg_eagle / n_other_eagle,
         prop_error_shapeit = n_other_cpg_shapeit / n_other_shapeit,
         prop_error_beagle = n_other_cpg_beagle / n_other_beagle) %>%
  select(pop, starts_with("prop_error")) %>%
  rename(EAGLE = prop_error_eagle,
         BEAGLE = prop_error_beagle,
         SHAPEIT = prop_error_shapeit) %>%
  pivot_longer(-pop, names_to = "method",  values_to = "prop") %>%
  ggplot(aes(x = method, y = prop)) + 
  geom_boxplot() +
  xlab("Method") +
  ylab("Proportion of switches at CpG") + 
  geom_abline(aes(slope = 0, intercept = background_cpg_het, colour = 'red'), show.legend = TRUE) +
  ggtitle("Proportion of Switches Starting at CpG Sites") +
  theme_bw(base_size = 14)  +
  scale_color_discrete(labels = "Background CpG Rate") +
  theme(legend.position = c(0.75, 0.9),
        legend.box.background = element_rect(color="black", linewidth=1),
        legend.title=element_blank())
```


```{r}
df_vcftools %>%
  ggplot(aes(x = n_switch_cpg_eagle, y = n_switch_cpg_shapeit, colour = pop)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  ggtitle("Errors at CpGs") +
  xlab("Errors EAGLE2") +
  ylab("Errors SHAPEIT5") +
  guides(colour=guide_legend(title="Population"))
```

## background CpG

```{r}
# df_cpg_hets  <- read_csv("/net/snowwhite/home/beckandy/research/phasing/data/ref/chrX_hets_anno.csv")
# table(df_cpg_hets$cpg_start)
# 254473 / (254437 + 1505670)
```

## frequency information

```{r}
library(readr)
# df_freq <- read_tsv("/net/snowwhite/home/beckandy/research/phasing/output/chrX_maf.tsv") %>%
#   filter(N_ALLELES == 2) %>%
#   rowwise() %>%
#   mutate(AF1 = as.numeric(str_split(A1, ":")[[1]][2]),
#          AF2 = as.numeric(str_split(A2, ":")[[1]][2])) %>%
#   mutate(maf = min(AF1, AF2))
# 
# # save off to avoid long load times
# write_tsv(df_freq, "/net/snowwhite/home/beckandy/research/phasing/output/chrX_maf_simple.tsv")

df_freq <- read_tsv("/net/snowwhite/home/beckandy/research/phasing/output/chrX_maf_simple.tsv")

df_freq %>%
  ggplot(aes(x = maf)) + geom_density() +
  ggtitle("MAF Distribution", "Chr X, 1kGP") +
  xlab("Minor Allele Frequency") +
  scale_x_log10()
```

## significance of enrichment

```{r}

df_vcftools %>%
  mutate(prop_error_eagle = n_switch_cpg_eagle / n_switch_eagle,
         prop_error_shapeit = n_switch_cpg_shapeit / n_switch_shapeit,
         prop_error_beagle = n_switch_cpg_beagle / n_switch_beagle) %>%
  pull(prop_error_eagle) %>%
  t.test(mu = 254437 / (254437 + 1505670))

df_vcftools %>%
  mutate(prop_error_eagle = n_switch_cpg_eagle / n_switch_eagle,
         prop_error_shapeit = n_switch_cpg_shapeit / n_switch_shapeit,
         prop_error_beagle = n_switch_cpg_beagle / n_switch_beagle) %>%
  pull(prop_error_beagle) %>%
  t.test(mu = 254437 / (254437 + 1505670))

df_vcftools %>%
  mutate(prop_error_eagle = n_switch_cpg_eagle / n_switch_eagle,
         prop_error_shapeit = n_switch_cpg_shapeit / n_switch_shapeit,
         prop_error_beagle = n_switch_cpg_beagle / n_switch_beagle) %>%
  pull(prop_error_shapeit) %>%
  t.test(mu = 254437 / (254437 + 1505670))


```

## Chi square on all 300 diploids

```{r}
exp_p <-  254437 / (254437 + 1505670)

df_vcftools %>%
  select(pair_id, n_switch_cpg_beagle, n_switch_beagle) %>%
  mutate(exp_switch = exp_p * n_switch_beagle) %>%
  mutate(chi_res = (n_switch_cpg_beagle - exp_switch)^2 / exp_switch) %>%
  ggplot(aes(x = chi_res)) +
  geom_density() +
  geom_vline(xintercept = qchisq(0.05, df = 1, lower.tail = F)) +
  ggtitle("Chi-Square Test: BEAGLE5", "Proportion of Errors at CpGs = Proportion 1KGP Variants at CpG") +
  xlab("Density") +
  ylab("Chi Square Statistics")

df_vcftools %>%
  select(pair_id, n_switch_cpg_eagle, n_switch_eagle) %>%
  mutate(exp_switch = exp_p * n_switch_eagle) %>%
  mutate(chi_res = (n_switch_cpg_eagle - exp_switch)^2 / exp_switch) %>%
  ggplot(aes(x = chi_res)) +
  geom_density() +
  geom_vline(xintercept = qchisq(0.05, df = 1, lower.tail = F)) +
  ggtitle("Chi-Square Test: EAGLE2", "Proportion of Errors at CpGs = Proportion 1KGP Variants at CpG") +
  xlab("Density") +
  ylab("Chi Square Statistics")

df_vcftools %>%
  select(pair_id, n_switch_cpg_shapeit, n_switch_shapeit) %>%
  mutate(exp_switch = exp_p * n_switch_shapeit) %>%
  mutate(chi_res = (n_switch_cpg_shapeit - exp_switch)^2 / exp_switch) %>%
  ggplot(aes(x = chi_res)) +
  geom_density() +
  geom_vline(xintercept = qchisq(0.05, df = 1, lower.tail = F)) +
  ggtitle("Chi-Square Test: SHAPEIT5", "Proportion of Errors at CpGs = Proportion 1KGP Variants at CpG") +
  xlab("Density") +
  ylab("Chi Square Statistics")


pchisq(9.22, df = 1, lower.tail = FALSE)
```

Flips:

```{r}
df_vcftools %>%
  select(pair_id, n_flip_cpg_beagle, n_flip_beagle) %>%
  mutate(exp_switch = exp_p * n_flip_beagle) %>%
  mutate(chi_res = (n_flip_cpg_beagle - exp_switch)^2 / exp_switch) %>%
  ggplot(aes(x = chi_res)) +
  geom_density() +
  geom_vline(xintercept = qchisq(0.05, df = 1, lower.tail = F)) +
  ggtitle("Chi-Square Test: BEAGLE5", "Proportion of Flips at CpGs = Proportion 1KGP Variants at CpG") +
  xlab("Density") +
  ylab("Chi Square Statistics")

df_vcftools %>%
  select(pair_id, n_flip_cpg_eagle, n_flip_eagle) %>%
  mutate(exp_switch = exp_p * n_flip_eagle) %>%
  mutate(chi_res = (n_flip_cpg_eagle - exp_switch)^2 / exp_switch) %>%
  ggplot(aes(x = chi_res)) +
  geom_density() +
  geom_vline(xintercept = qchisq(0.05, df = 1, lower.tail = F)) +
  ggtitle("Chi-Square Test: EAGLE2", "Proportion of Flips at CpGs = Proportion 1KGP Variants at CpG") +
  xlab("Density") +
  ylab("Chi Square Statistics")

df_vcftools %>%
  select(pair_id, n_flip_shapeit, n_flip_cpg_shapeit) %>%
  mutate(exp_switch = exp_p * n_flip_shapeit) %>%
  mutate(chi_res = (n_flip_cpg_shapeit - exp_switch)^2 / exp_switch) %>%
  ggplot(aes(x = chi_res)) +
  geom_density() +
  geom_vline(xintercept = qchisq(0.05, df = 1, lower.tail = F)) +
  ggtitle("Chi-Square Test: SHAPEIT5", "Proportion of Flips at CpGs = Proportion 1KGP Variants at CpG") +
  xlab("Density") +
  ylab("Chi Square Statistics")
```

## Distance Metrics

```{r}
df_vcftools %>%
  select(pop, starts_with("median")) %>%
  rename(EAGLE = median_dist_eagle ,
         BEAGLE = median_dist_beagle ,
         SHAPEIT = median_dist_shapeit ) %>%
  pivot_longer(-pop, names_to = "method",  values_to = "med_dist") %>%
  ggplot(aes(x = method, y = med_dist)) + 
  geom_boxplot() +
  xlab("Method") +
  ylab("Median Distance Between Errors") + 
  ggtitle("Median Distance Between Errors") +
  theme_bw(base_size = 14)
```



## MAF of switch sites (single pseudo-diploid)

```{r}
df_pd_eagle <-  read_csv(paste0(eagle_switch_dir, "switch_", 1, ".csv"), show_col_types = FALSE) 
df_pd_shapeit <- read_csv(paste0(shapeit_switch_dir, "switch_", 1, ".csv"), show_col_types = FALSE) 
df_pd_beagle <- read_csv(paste0(beagle_switch_dir, "switch_", 1, ".csv"), show_col_types = FALSE) 

flip_pos_eagle <- get_flip_pos(df_pd_eagle)
flip_pos_beagle <- get_flip_pos(df_pd_beagle)
flip_pos_shapeit <- get_flip_pos(df_pd_shapeit)

# Assign switches flip status
df_pd_eagle$is_flip <- df_pd_eagle$pos_end %in% flip_pos_eagle
df_pd_beagle$is_flip <- df_pd_beagle$pos_end %in% flip_pos_beagle
df_pd_shapeit$is_flip <- df_pd_shapeit$pos_end %in% flip_pos_shapeit

df_pd_eagle$part_of_flip <- ifelse(df_pd_eagle$is_flip, TRUE, df_pd_eagle$pos_start %in% flip_pos_eagle)
df_pd_beagle$part_of_flip <- ifelse(df_pd_beagle$is_flip, TRUE, df_pd_beagle$pos_start %in% flip_pos_beagle)
df_pd_shapeit$part_of_flip <- ifelse(df_pd_shapeit$is_flip, TRUE, df_pd_shapeit$pos_start %in% flip_pos_shapeit)

# match start pos to maf
df_pd_beagle <- df_pd_beagle %>%
  inner_join({df_freq %>% select(POS, maf)}, by=c("pos_start" = "POS"))

df_pd_eagle <- df_pd_eagle %>%
  inner_join({df_freq %>% select(POS, maf)}, by=c("pos_start" = "POS"))

df_pd_shapeit <- df_pd_shapeit %>%
  inner_join({df_freq %>% select(POS, maf)}, by=c("pos_start" = "POS"))

df_pd_maf <- df_pd_beagle %>%
  select(maf, is_flip) %>%
  mutate(method = "beagle") %>%
  bind_rows({df_pd_eagle %>% select(maf, is_flip) %>% mutate(method = "eagle")}) %>%
   bind_rows({df_pd_shapeit %>% select(maf, is_flip) %>% mutate(method = "shapeit")})

df_pd_maf %>%
  ggplot(aes(x = maf, colour = method)) +
  geom_density() +
  ggtitle("MAF at switch sites", "EUR: X1, X2") +
  xlab("MAF") +
  ylab("Density")

df_pd_maf %>%
  filter(is_flip) %>%
  ggplot(aes(x = maf, colour = method)) +
  geom_density() +
  ggtitle("MAF at flip sites", "EUR: X1, X2") +
  xlab("MAF") +
  ylab("Density")
  
get_dens_for_pd <- function(pair_id){
  print(pair_id)
  df_pd_eagle <-  read_csv(paste0(eagle_switch_dir, "switch_", pair_id, ".csv"), show_col_types = FALSE) 
  df_pd_shapeit <- read_csv(paste0(shapeit_switch_dir, "switch_", pair_id, ".csv"), show_col_types = FALSE) 
  df_pd_beagle <- read_csv(paste0(beagle_switch_dir, "switch_", pair_id, ".csv"), show_col_types = FALSE) 
  
  flip_pos_eagle <- get_flip_pos(df_pd_eagle)
  flip_pos_beagle <- get_flip_pos(df_pd_beagle)
  flip_pos_shapeit <- get_flip_pos(df_pd_shapeit)
  
  # Assign switches flip status
  df_pd_eagle$is_flip <- df_pd_eagle$pos_end %in% flip_pos_eagle
  df_pd_beagle$is_flip <- df_pd_beagle$pos_end %in% flip_pos_beagle
  df_pd_shapeit$is_flip <- df_pd_shapeit$pos_end %in% flip_pos_shapeit
  
  df_pd_eagle$part_of_flip <- ifelse(df_pd_eagle$is_flip, TRUE, df_pd_eagle$pos_start %in% flip_pos_eagle)
  df_pd_beagle$part_of_flip <- ifelse(df_pd_beagle$is_flip, TRUE, df_pd_beagle$pos_start %in% flip_pos_beagle)
  df_pd_shapeit$part_of_flip <- ifelse(df_pd_shapeit$is_flip, TRUE, df_pd_shapeit$pos_start %in% flip_pos_shapeit)
  
  # match start pos to maf
  df_pd_beagle <- df_pd_beagle %>%
    inner_join({df_freq %>% select(POS, maf)}, by=c("pos_start" = "POS"))
  
  df_pd_eagle <- df_pd_eagle %>%
    inner_join({df_freq %>% select(POS, maf)}, by=c("pos_start" = "POS"))
  
  df_pd_shapeit <- df_pd_shapeit %>%
    inner_join({df_freq %>% select(POS, maf)}, by=c("pos_start" = "POS"))
  
  df_pd_maf <- df_pd_beagle %>%
    select(maf, is_flip) %>%
    mutate(method = "beagle") %>%
    bind_rows({df_pd_eagle %>% select(maf, is_flip) %>% mutate(method = "eagle")}) %>%
     bind_rows({df_pd_shapeit %>% select(maf, is_flip) %>% mutate(method = "shapeit")})
  
  med_maf <- median(df_pd_maf$maf, na.rm = T)
  med_maf_flip <- df_pd_maf %>%
    filter(is_flip) %>%
    pull(maf) %>%
    median(na.rm=T)
  
  p1 <- df_pd_maf %>%
    ggplot(aes(x = maf, colour = method)) +
    geom_density() +
    ggtitle("MAF at switch sites", paste0(pair_info_df$SP[pair_id],": ",pair_info_df$ID1[pair_id]," ", pair_info_df$ID2[pair_id], "; Median MAF: ", med_maf )) +
    xlab("MAF") +
    ylab("Density")
  print(p1)
  
  p2 <- df_pd_maf %>%
    filter(is_flip) %>%
    ggplot(aes(x = maf, colour = method)) +
    geom_density() +
    ggtitle("MAF at flip sites", paste0(pair_info_df$SP[pair_id],": ",pair_info_df$ID1[pair_id]," ", pair_info_df$ID2[pair_id], "; Median MAF: ", med_maf_flip)) +
    xlab("MAF") +
    ylab("Density")
  print(p2)
}

get_dens_for_pd(sample(401:700, 1))
get_dens_for_pd(sample(1:200, 1))

df_freq %>%
  ggplot(aes(x = maf)) +
  geom_boxplot()
```

## Distribution of errors across MB windows

```{r}
pair_id <- 27
df_pd_eagle <-  read_csv(paste0(eagle_switch_dir, "switch_", pair_id, ".csv"), show_col_types = FALSE) 
df_pd_shapeit <- read_csv(paste0(shapeit_switch_dir, "switch_", pair_id, ".csv"), show_col_types = FALSE) 
df_pd_beagle <- read_csv(paste0(beagle_switch_dir, "switch_", pair_id, ".csv"), show_col_types = FALSE) 

flip_pos_eagle <- get_flip_pos(df_pd_eagle)
flip_pos_beagle <- get_flip_pos(df_pd_beagle)
flip_pos_shapeit <- get_flip_pos(df_pd_shapeit)

# Assign switches flip status
df_pd_eagle$is_flip <- df_pd_eagle$pos_end %in% flip_pos_eagle
df_pd_beagle$is_flip <- df_pd_beagle$pos_end %in% flip_pos_beagle
df_pd_shapeit$is_flip <- df_pd_shapeit$pos_end %in% flip_pos_shapeit

df_pd_eagle$part_of_flip <- ifelse(df_pd_eagle$is_flip, TRUE, df_pd_eagle$pos_start %in% flip_pos_eagle)
df_pd_beagle$part_of_flip <- ifelse(df_pd_beagle$is_flip, TRUE, df_pd_beagle$pos_start %in% flip_pos_beagle)
df_pd_shapeit$part_of_flip <- ifelse(df_pd_shapeit$is_flip, TRUE, df_pd_shapeit$pos_start %in% flip_pos_shapeit)

df_pd_eagle$bin <- ceiling(df_pd_eagle$pos_start / 1000)
df_pd_beagle$bin <- ceiling(df_pd_beagle$pos_start / 1000)
df_pd_shapeit$bin <- ceiling(df_pd_shapeit$pos_start / 1000)

df_pd_eagle %>%
  select(bin) %>%
  group_by(bin) %>%
  summarize(n = n()) %>%
  pull(n) %>%
  table()

counts_per_bin <- function(ids = 1:200, bin_w = 1000){
  df_pd_eagle <-  read_csv(paste0(eagle_switch_dir, "switch_", ids[1], ".csv"), show_col_types = FALSE) 
  df_pd_shapeit <- read_csv(paste0(shapeit_switch_dir, "switch_", ids[1], ".csv"), show_col_types = FALSE) 
  df_pd_beagle <- read_csv(paste0(beagle_switch_dir, "switch_", ids[1], ".csv"), show_col_types = FALSE) 
  
  df_pd_eagle$bin <- ceiling(df_pd_eagle$pos_start / bin_w)
  df_pd_beagle$bin <- ceiling(df_pd_beagle$pos_start / bin_w)
  df_pd_shapeit$bin <- ceiling(df_pd_shapeit$pos_start / bin_w)
  
  df_pd_eagle <- df_pd_eagle %>%
    select(bin) %>%
    group_by(bin) %>%
    summarize(n = n())
  df_pd_beagle <- df_pd_beagle %>%
    select(bin) %>%
    group_by(bin) %>%
    summarize(n = n())
  df_pd_shapeit <- df_pd_shapeit %>%
    select(bin) %>%
    group_by(bin) %>%
    summarize(n = n())
  
  if(length(ids) == 1){
    df_pd_eagle$method = "eagle"
    df_pd_beagle$method = "beagle"
    df_pd_shapeit$method = "shapeit"
    
    df <- bind_rows(df_pd_beagle, df_pd_eagle) %>%
      bind_rows(df_pd_shapeit)
    return(df)
  }
  
  for(i in 2:length(ids)){
    df_pd_eagle2 <-  read_csv(paste0(eagle_switch_dir, "switch_", ids[i], ".csv"), show_col_types = FALSE) 
    df_pd_shapeit2 <- read_csv(paste0(shapeit_switch_dir, "switch_", ids[i], ".csv"), show_col_types = FALSE) 
    df_pd_beagle2 <- read_csv(paste0(beagle_switch_dir, "switch_", ids[i], ".csv"), show_col_types = FALSE) 
    
    df_pd_eagle2$bin <- ceiling(df_pd_eagle2$pos_start / bin_w)
    df_pd_beagle2$bin <- ceiling(df_pd_beagle2$pos_start / bin_w)
    df_pd_shapeit2$bin <- ceiling(df_pd_shapeit2$pos_start / bin_w)
    
    df_pd_eagle2 <- df_pd_eagle2 %>%
      select(bin) %>%
      group_by(bin) %>%
      summarize(n = n())
    df_pd_beagle2 <- df_pd_beagle2 %>%
      select(bin) %>%
      group_by(bin) %>%
      summarize(n = n())
    df_pd_shapeit2 <- df_pd_shapeit2 %>%
      select(bin) %>%
      group_by(bin) %>%
      summarize(n = n())
    
    df_pd_eagle <- df_pd_eagle %>%
      full_join(df_pd_eagle2, by = "bin") %>%
      replace_na(list("n.x" = 0, "n.y" = 0)) %>%
      mutate(n = n.x + n.y) %>%
      select(bin, n)
    df_pd_beagle <- df_pd_beagle %>%
      full_join(df_pd_beagle2, by = "bin") %>%
      replace_na(list("n.x" = 0, "n.y" = 0)) %>%
      mutate(n = n.x + n.y) %>%
      select(bin, n)
    df_pd_shapeit <- df_pd_shapeit %>%
      full_join(df_pd_shapeit2, by = "bin") %>%
      replace_na(list("n.x" = 0, "n.y" = 0)) %>%
      mutate(n = n.x + n.y) %>%
      select(bin, n)
  }
  df_pd_eagle$method = "eagle"
  df_pd_beagle$method = "beagle"
  df_pd_shapeit$method = "shapeit"
  
  df <- bind_rows(df_pd_beagle, df_pd_eagle) %>%
    bind_rows(df_pd_shapeit)
  return(df)
}

eur_cnt_1mb <- counts_per_bin(1:200 ,bin_w = 1e6)
afr_cnt_1mb <- counts_per_bin(201:400, bin_w = 1e6)
amr_cnt_1mb <- counts_per_bin(401:500, bin_w = 1e6)
eas_cnt_1mb <- counts_per_bin(501:600, bin_w = 1e6)
sas_cnt_1mb <- counts_per_bin(601:700, bin_w = 1e6)
```

```{r}

afr_cnt_1mb %>%
  ggplot(aes(x = bin, y = n, colour = method)) +
  geom_line() +
  ggtitle("Total switches per MB Bin: AFR PDs") +
  xlab("MB Bin") +
  ylab("Switches") +
  scale_color_manual(values = cbPalette)

eur_cnt_1mb %>%
  ggplot(aes(x = bin, y = n, colour = method)) +
  geom_line() +
  ggtitle("Total switches per MB Bin: EUR PDs") +
  xlab("MB Bin") +
  ylab("Switches") +
  scale_color_manual(values = cbPalette)

amr_cnt_1mb %>%
  ggplot(aes(x = bin, y = n, colour = method)) +
  geom_line() +
  ggtitle("Total switches per MB Bin: AMR PDs") +
  xlab("MB Bin") +
  ylab("Switches") +
  scale_color_manual(values = cbPalette)

eas_cnt_1mb %>%
  ggplot(aes(x = bin, y = n, colour = method)) +
  geom_line() +
  ggtitle("Total switches per MB Bin: EAS PDs") +
  xlab("MB Bin") +
  ylab("Switches") +
  scale_color_manual(values = cbPalette)

sas_cnt_1mb %>%
  ggplot(aes(x = bin, y = n, colour = method)) +
  geom_line() +
  ggtitle("Total switches per MB Bin: SAS PDs") +
  xlab("MB Bin") +
  ylab("Switches") +
  scale_color_manual(values = cbPalette)
```

